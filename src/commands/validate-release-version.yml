# Copyright (c) 2018, salesforce.com, inc.
# All rights reserved.
# SPDX-License-Identifier: BSD-3-Clause
# For full license text, see the LICENSE file in the repo root or https://opensource.org/licenses/BSD-3-Clause

# How to author commands: https://circleci.com/docs/2.0/reusing-config/#authoring-reusable-commands
description: >
  Checks that the package.json version is valid

steps:
  - jq/install
  - run:
      name: Check if version already exists in registry
      command: |
        PKG_NAME=$(cat package.json | jq -r .name)
        PKG_VERSION=$(cat package.json | jq -r .version)
        VERSIONS=$(npm view $PKG_NAME versions --json | jq .)

        echo "Version we want to release: ${PKG_VERSION}"
        echo "Existing versions of ${PKG_NAME}:"
        echo $VERSIONS

        # Searches array of versions for one that matches the version we're attempting to publish in the job
        # If the version already exists, MATCHING_VERSIONS will be >= 1 otherwise it will be 0
        MATCHING_VERSIONS=$(echo $VERSIONS | jq "map(select(. == \"${PKG_VERSION}\")) | length")
        echo "Number of matching versions: ${MATCHING_VERSIONS}"
        if (( $MATCHING_VERSIONS >= 1 )); then
            echo "${PKG_NAME}@${PKG_VERSION} already exists in the npm registry..."
            echo "Exiting release"
            exit 1
        else
          echo "${PKG_NAME}@${PKG_VERSION} does not exist in the npm registry..."
          echo "Proceeding with release"
        fi
