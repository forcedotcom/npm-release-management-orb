# Copyright (c) 2018, salesforce.com, inc.
# All rights reserved.
# SPDX-License-Identifier: BSD-3-Clause
# For full license text, see the LICENSE file in the repo root or https://opensource.org/licenses/BSD-3-Clause

# How to author commands: https://circleci.com/docs/2.0/reusing-config/#authoring-reusable-commands
description: >
  Checks that the package.json version is valid

steps:
  - jq/install
  - install-standard-version
  - run:
      name: Check if version already exists in registry
      command: |
        PKG_NAME=$(cat package.json | jq -r .name)
        PKG_VERSION=$(cat package.json | jq -r .version)
        VERSIONS=$(npm view $PKG_NAME versions --json | jq .)
        EXISTS_IN_REGISTRY=$(echo $VERSIONS | jq "map(select(. == \"${PKG_VERSION}\")) | length")

        # if PKG_VERSION does NOT exist in registry, then we can assume that it's the version we want published
        if (( $EXISTS_IN_REGISTRY == 0 )); then
            echo "${PKG_NAME}@${PKG_VERSION} (as specifed in the package.json) does not exist in the registry. Assuming that we want to publish it"

        # if PKG_VERSION does exist in the registry, then we assume that standard-version will handle the bump
        else
            VERSION_TO_BE_PUBLISHED=$(standard-version --dry-run --skip.tag --skip.commit --skip.changelog | grep -o 'to\s.*' | awk '{print $2}')
            echo "Verifying that version determined by standard-version (${VERSION_TO_BE_PUBLISHED}) does not exist in registry"
            EXISTS_IN_REGISTRY=$(echo $VERSIONS | jq "map(select(. == \"${VERSION_TO_BE_PUBLISHED}\")) | length")
            if (( $EXISTS_IN_REGISTRY == 0 )); then
                echo "${PKG_NAME}@${VERSION_TO_BE_PUBLISHED} does not exist in the registry. Proceeding..."
                exit 0
            else
                echo "${PKG_NAME}@${VERSION_TO_BE_PUBLISHED} already exists in the registry. Exiting..."
                exit 1
            fi
        fi
