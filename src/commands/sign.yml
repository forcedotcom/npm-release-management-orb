# Copyright (c) 2018, salesforce.com, inc.
# All rights reserved.
# SPDX-License-Identifier: BSD-3-Clause
# For full license text, see the LICENSE file in the repo root or https://opensource.org/licenses/BSD-3-Clause

# How to author commands: https://circleci.com/docs/2.0/reusing-config/#authoring-reusable-commands
description: >
  Signs npm package using @salesforce/sfdx-trust

parameters:
  fingerprint:
    description: developer trusted fingerprint for signing packages
    default: '22:F4:87:2C:B2:22:04:1E:F5:D2:AB:AE:E7:69:81:10:1E:C1:F7:0B'
    type: string

steps:
  - jq/install
  - setup-aws
  - install-sfdx-trust
  - run:
      name: Set salesforce credentials
      command: |
        echo $SALESFORCE_KEY | base64 --decode > $HOME/salesforce-cli.key
  - run:
      name: Sign npm package
      command: |
        export SFDX_DEVELOPER_TRUSTED_FINGERPRINT=<<parameters.fingerprint>>
        RESULT=$(sfdx-trust plugins:trust:sign \
          --signatureurl https://developer.salesforce.com/media/salesforce-cli/signatures \
          --publickeyurl https://developer.salesforce.com/media/salesforce-cli/sfdx-cli-03032020.crt \
          --privatekeypath $HOME/salesforce-cli.key \
          --json)
        printf '%s' "$RESULT" | jq .

        echo "Cleaning up the signing key"
        rm -f $HOME/salesforce-cli.key

        STATUS=$(printf '%s' "$RESULT" | jq .status)

        if (($STATUS >= 1)); then
            ERROR=$(printf '%s' "$RESULT" | jq .message)
            echo "Signing failed: ${ERROR}"
            exit 1
        fi

        FILE_NAME=$(echo $RESULT | jq -r '.result.filename')
        aws s3 cp $FILE_NAME s3://dfc-data-production/media/salesforce-cli/signatures/
